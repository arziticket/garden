<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Donation Receipt App - Prototype</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 20px; }
    .voice-btn.recording { box-shadow: 0 0 0 8px rgba(25,135,84,.08); }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-3">Donation Receipt App â€” Minimal Prototype</h2>
    <p class="text-muted">Voice-assist data entry â†’ saves to browser DB â†’ Export to Excel / View reports.</p>

    <div class="card mb-3">
      <div class="card-body">
        <form id="donationForm" autocomplete="off">
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Donor Name</label>
              <input type="text" id="donorName" class="form-control" placeholder="Full name">
            </div>
            <div class="col-md-4">
              <label class="form-label">Amount (INR)</label>
              <input type="number" id="amount" class="form-control" placeholder="Amount">
            </div>
            <div class="col-md-4">
              <label class="form-label">Date</label>
              <input type="date" id="donationDate" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Phone / Contact</label>
              <input type="text" id="contact" class="form-control" placeholder="Phone or email">
            </div>
            <div class="col-md-8">
              <label class="form-label">Notes / Type (e.g., "Bougainvillea donation")</label>
              <input type="text" id="notes" class="form-control" placeholder="Notes / category">
            </div>
          </div>

          <div class="d-flex gap-2 mt-3">
            <button type="button" id="saveBtn" class="btn btn-primary">Save to DB</button>
            <button type="button" id="clearBtn" class="btn btn-outline-secondary">Clear</button>

            <div class="ms-auto">
              <button type="button" id="voiceBtn" class="btn btn-success voice-btn">ðŸŽ¤ Voice Fill</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="card mb-3">
          <div class="card-header">Saved Records</div>
          <div class="card-body p-0">
            <div class="table-responsive" style="max-height:360px; overflow:auto;">
              <table class="table table-sm table-hover mb-0" id="recordsTable">
                <thead class="table-light sticky-top">
                  <tr><th>#</th><th>Name</th><th>Amount</th><th>Date</th><th>Notes</th><th>Actions</th></tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div class="p-2 border-top">
              <button id="exportExcel" class="btn btn-outline-primary btn-sm">Export All â†’ Excel</button>
              <button id="deleteAll" class="btn btn-danger btn-sm">Delete All</button>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card mb-3">
          <div class="card-header">Reports / Filters</div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-12 col-md-6">
                <label>From</label>
                <input type="date" id="reportFrom" class="form-control">
              </div>
              <div class="col-12 col-md-6">
                <label>To</label>
                <input type="date" id="reportTo" class="form-control">
              </div>
              <div class="col-12 mt-2">
                <label>Filter by Notes / Type (contains)</label>
                <input type="text" id="reportNotes" class="form-control" placeholder="e.g. Bougainvillea">
              </div>
              <div class="col-12 mt-2 d-flex gap-2">
                <button id="applyReport" class="btn btn-primary">Apply</button>
                <button id="resetReport" class="btn btn-outline-secondary">Reset</button>
              </div>
            </div>

            <hr>
            <div id="reportSummary"></div>
            <div id="reportTableWrapper" style="max-height:260px; overflow:auto;">
              <table class="table table-sm mt-2" id="reportTable">
                <thead class="table-light"><tr><th>#</th><th>Name</th><th>Amount</th><th>Date</th><th>Notes</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <hr>
    <p class="text-muted small">How voice works: click <strong>Voice Fill</strong>, speak the field name and value separated by a short pause (e.g. "name: John Kumar" then "amount: 500" then "notes: Bougainvillea donation"). Use Save to store the record.</p>
  </div>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- SheetJS for XLSX export -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
  // ---------- Simple IndexedDB wrapper (promises) ----------
  const DB_NAME = 'donation-db-v1';
  const STORE = 'donations';
  function openDb() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(STORE)) {
          const store = db.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
          store.createIndex('date', 'date', { unique: false });
          store.createIndex('name', 'name', { unique: false });
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  async function addRecord(obj) {
    const db = await openDb();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE,'readwrite');
      tx.objectStore(STORE).add(obj);
      tx.oncomplete = () => resolve(true);
      tx.onerror = () => reject(tx.error);
    });
  }
  async function getAllRecords() {
    const db = await openDb();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE,'readonly');
      const req = tx.objectStore(STORE).getAll();
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  async function deleteRecord(id) {
    const db = await openDb();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE,'readwrite');
      tx.objectStore(STORE).delete(id);
      tx.oncomplete = () => resolve(true);
      tx.onerror = () => reject(tx.error);
    });
  }
  async function clearAll() {
    const db = await openDb();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE,'readwrite');
      tx.objectStore(STORE).clear();
      tx.oncomplete = () => resolve(true);
      tx.onerror = () => reject(tx.error);
    });
  }

  // ---------- UI helpers ----------
  const $ = id => document.getElementById(id);
  function formatDate(d){ if(!d) return ''; return new Date(d).toISOString().slice(0,10); }

  async function refreshTable(){
    const rows = await getAllRecords();
    const tbody = document.querySelector('#recordsTable tbody');
    tbody.innerHTML = '';
    rows.sort((a,b)=> new Date(b.date) - new Date(a.date));
    rows.forEach((r,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.id}</td><td>${r.name||''}</td><td>${r.amount||''}</td><td>${r.date||''}</td><td>${r.notes||''}</td><td><button data-id='${r.id}' class='btn btn-sm btn-outline-danger del'>Delete</button></td>`;
      tbody.appendChild(tr);
    });
    document.querySelectorAll('.del').forEach(btn=> btn.addEventListener('click', async e=>{
      const id = Number(e.currentTarget.dataset.id);
      if(confirm('Delete record #' + id + '?')){ await deleteRecord(id); await refreshTable(); await refreshReport(); }
    }));
  }

  // ---------- Form actions ----------
  $('saveBtn').addEventListener('click', async ()=>{
    const obj = collectForm();
    if(!obj.name || !obj.amount) return alert('Please enter at least Name and Amount');
    await addRecord(obj);
    clearForm();
    await refreshTable();
    await refreshReport();
  });
  $('clearBtn').addEventListener('click', clearForm);
  $('deleteAll').addEventListener('click', async ()=>{ if(confirm('Delete ALL records?')){ await clearAll(); await refreshTable(); await refreshReport(); }});

  function collectForm(){
    return {
      name: $('donorName').value.trim(),
      amount: Number($('amount').value) || 0,
      date: $('donationDate').value || formatDate(new Date()),
      contact: $('contact').value.trim(),
      notes: $('notes').value.trim(),
      createdAt: new Date().toISOString()
    };
  }
  function clearForm(){ document.querySelector('#donationForm').reset(); }

  // ---------- Reports ----------
  async function refreshReport(){
    const all = await getAllRecords();
    applyReportFilterAndRender(all);
  }
  function applyReportFilterAndRender(rows){
    const from = $('reportFrom').value; const to = $('reportTo').value; const notes = $('reportNotes').value.trim().toLowerCase();
    let filtered = rows.slice();
    if(from) filtered = filtered.filter(r=> r.date >= from);
    if(to) filtered = filtered.filter(r=> r.date <= to);
    if(notes) filtered = filtered.filter(r=> (r.notes||'').toLowerCase().includes(notes));

    const sum = filtered.reduce((s,r)=> s + Number(r.amount || 0), 0);
    const count = filtered.length;
    $('reportSummary').innerHTML = `<strong>Total:</strong> ${sum} | <strong>Count:</strong> ${count}`;

    const tbody = document.querySelector('#reportTable tbody'); tbody.innerHTML='';
    filtered.sort((a,b)=> new Date(b.date) - new Date(a.date)).forEach((r,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${r.name||''}</td><td>${r.amount||''}</td><td>${r.date||''}</td><td>${r.notes||''}</td>`;
      tbody.appendChild(tr);
    });
  }
  $('applyReport').addEventListener('click', async ()=>{ const all = await getAllRecords(); applyReportFilterAndRender(all); });
  $('resetReport').addEventListener('click', async ()=>{ $('reportFrom').value=''; $('reportTo').value=''; $('reportNotes').value=''; const all = await getAllRecords(); applyReportFilterAndRender(all); });

  // ---------- Export Excel (SheetJS) ----------
  $('exportExcel').addEventListener('click', async ()=>{
    const all = await getAllRecords();
    if(!all.length) return alert('No records to export');
    // Convert to worksheet
    const data = all.map(r=> ({ID: r.id, Name: r.name, Amount: r.amount, Date: r.date, Contact: r.contact, Notes: r.notes, CreatedAt: r.createdAt}));
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Donations');
    XLSX.writeFile(wb, 'donations.xlsx');
  });

  // ---------- Voice assist (Web Speech API) ----------
  let recognition=null;
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
  if(SpeechRecognition){
    recognition = new SpeechRecognition();
    recognition.lang = 'en-IN';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = e => {
      const text = e.results[0][0].transcript.trim();
      // Accept simple "field: value" or just phrases
      parseVoiceText(text);
    };
    recognition.onerror = e => { console.warn('Speech error', e); alert('Voice error: ' + e.error); toggleVoiceBtn(false); };
    recognition.onend = ()=> toggleVoiceBtn(false);
  } else {
    document.querySelector('.voice-btn').disabled = true;
    document.querySelector('.voice-btn').title = 'Speech recognition not supported in this browser';
  }

  function toggleVoiceBtn(active){ const btn = $('voiceBtn'); if(active){ btn.classList.add('recording'); btn.textContent='ðŸŽ™ï¸ Listening...'; } else { btn.classList.remove('recording'); btn.textContent='ðŸŽ¤ Voice Fill'; }}

  $('voiceBtn').addEventListener('click', ()=>{
    if(!recognition) return alert('Speech recognition not supported');
    try{ recognition.start(); toggleVoiceBtn(true);}catch(err){ console.warn(err); }
  });

  function parseVoiceText(text){
    // Examples the user might say:
    // "name John Kumar", "name: John Kumar", "amount 500", "amount: five hundred" (numbers handled roughly)
    // We'll try to detect field names then fill.
    text = text.replace(/\s+at\s+/gi, ' '); // cleanup
    // Try to split on colon first
    if(text.includes(':')){
      const [fieldRaw, ...rest] = text.split(':');
      const field = fieldRaw.trim().toLowerCase();
      const value = rest.join(':').trim();
      assignField(field, value);
      return;
    }
    // Otherwise look for patterns like "name John Kumar" or "amount 500"
    const parts = text.split(/\s+/);
    const key = parts[0].toLowerCase();
    const value = parts.slice(1).join(' ');
    assignField(key, value);
  }

  function assignField(key, value){
    if(!value) return; // nothing to assign
    // basic mapping
    if(['name','donor','donorname','donor name','donor_name'].includes(key)){
      $('donorName').value = value;
    } else if(['amount','rupees','rs','rupee'].includes(key)){
      // try to parse numbers from value
      const num = parseSpokenNumber(value);
      $('amount').value = num || value.match(/\d+/)?.[0] || value;
    } else if(['date','on','donationdate'].includes(key)){
      // try to parse date naive: if value like 2025-12-01 or words
      const d = new Date(value);
      if(!isNaN(d)) $('donationDate').value = formatDate(d);
      else $('donationDate').value = value; // leave raw
    } else if(['notes','note','type','category'].includes(key)){
      $('notes').value = value;
    } else if(['contact','phone','mobile','email'].includes(key)){
      $('contact').value = value;
    } else {
      // try to be smart: if phrase has "rupee" or numbers, assume amount; if includes '@' or digits length, contact
      if(/\b(rupee|rs|â‚¹)\b/i.test(value) || /\d/.test(value) && /\d{2,}/.test(value)){
        const num = parseSpokenNumber(value);
        if(num) $('amount').value = num;
      } else {
        // fallback: append to notes
        const cur = $('notes').value;
        $('notes').value = (cur? cur + ' | ' : '') + key + ' ' + value;
      }
    }
  }

  function parseSpokenNumber(text){
    // Very simple handling: convert words to digits for common small numbers. For larger / complex phrases, fallback to digits in text.
    const small = {zero:0, one:1, two:2, three:3, four:4, five:5, six:6, seven:7, eight:8, nine:9, ten:10, twenty:20, thirty:30, forty:40, fifty:50, hundred:100, thousand:1000};
    let n = 0; let last = 0; let found=false;
    const tokens = text.toLowerCase().replace(/[^a-z0-9 ]+/g,' ').split(/\s+/).filter(Boolean);
    for(const t of tokens){
      if(/\d+/.test(t)){ found=true; return Number(t.replace(/[^0-9]/g,'')); }
      if(t in small){ found=true; const val = small[t]; if(val>=100){ last = Math.max(1,last) * val; n = n || 0; n = (n||1) * val + (n%val? n - val: 0); } else { n += val; } }
    }
    return found? n : null;
  }

  // init
  (async ()=>{ const today = formatDate(new Date()); $('donationDate').value = today; await refreshTable(); await refreshReport(); })();
  </script>
</body>
</html>
